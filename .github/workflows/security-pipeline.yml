name: Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety semgrep pytest pytest-cov
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-results.json || true
    
    - name: Run Safety check
      run: |
        safety check -r requirements.txt --output json --file safety-results.json || true
    
    - name: Run Semgrep scan
      run: |
        semgrep --config=auto --json --output=semgrep-results.json . || true
    
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          bandit-results.json
          safety-results.json
          semgrep-results.json

  red-team-tests:
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov transformers torch
    
    - name: Run Red Team Tests
      run: |
        pytest tests/test_red_team.py -v --tb=short --disable-warnings
    
    - name: Run Adversarial Robustness Tests
      run: |
        pytest tests/test_adversarial_robustness.py -v --tb=short --disable-warnings

  blue-team-tests:
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run Blue Team Tests
      run: |
        pytest tests/test_blue_team.py -v --tb=short --disable-warnings
    
    - name: Run Threat Detection Tests
      run: |
        pytest tests/test_threat_detection.py -v --tb=short --disable-warnings

  compliance-check:
    runs-on: ubuntu-latest
    needs: [red-team-tests, blue-team-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run NIST AI RMF Compliance Tests
      run: |
        pytest tests/test_compliance.py -v --tb=short --disable-warnings
    
    - name: Generate Compliance Report
      run: |
        python -c "
        from src.compliance.nist_ai_rmf import NistAIRMFramework
        framework = NistAIRMFramework()
        report = framework.run_complete_assessment()
        import json
        with open('compliance_report.json', 'w') as f:
            json.dump(report, f, indent=2, default=str)
        "

  integration-tests:
    runs-on: ubuntu-latest
    needs: [red-team-tests, blue-team-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov transformers torch
    
    - name: Run End-to-End Integration Tests
      run: |
        pytest tests/test_end_to_end.py -v --tb=short --disable-warnings
    
    - name: Run Full Pipeline Tests
      run: |
        pytest tests/test_pipeline_integration.py -v --tb=short --disable-warnings

  model-robustness:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov transformers torch
    
    - name: Load HuggingFace Model
      run: |
        pip install huggingface_hub
        python -c '
        from huggingface_hub import snapshot_download
        from pathlib import Path
        import os
        # Download model to cache
        snapshot_download(repo_id="Titeiiko/OTIS-Official-Spam-Model", local_dir="model_cache")
        print("Model downloaded successfully")
        '
    
    - name: Run Model Robustness Tests
      run: |
        pytest tests/test_model_robustness.py -v --tb=short --disable-warnings

  final-report:
    runs-on: ubuntu-latest
    needs: [model-robustness, compliance-check]
    if: ${{ always() }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install reporting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate Final Security Report
      run: |
        python -c "
        import json
        import os
        from datetime import datetime
        
        # Collect all test results
        results = {
            'timestamp': datetime.now().isoformat(),
            'pipeline_status': 'success' if all([
                os.path.exists('artifacts/security-scan-results'),
                os.path.exists('artifacts/red-team-tests'),
                os.path.exists('artifacts/blue-team-tests')
            ]) else 'failure',
            'artifacts_downloaded': os.listdir('artifacts/') if os.path.exists('artifacts/') else []
        }
        
        # Save combined report
        with open('final_security_report.json', 'w') as f:
            json.dump(results, f, indent=2)
        "
    
    - name: Upload Final Report
      uses: actions/upload-artifact@v4
      with:
        name: final-security-report
        path: final_security_report.json
    
    - name: Check Pipeline Status
      run: |
        if [ -f final_security_report.json ]; then
          STATUS=$(python -c 'import json; print(json.load(open(\"final_security_report.json\"))[\"pipeline_status\"])')
          if [ \"$STATUS\" = \"failure\" ]; then
            echo 'Pipeline failed, see artifacts for details'
            exit 1
          else
            echo 'Pipeline completed successfully'
            exit 0
          fi
        else
          echo 'Final report not found'
          exit 1
        fi